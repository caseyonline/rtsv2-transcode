// [LLNW RTS INGEST SDK]  v2.0.0 built 2020-04-23T12:54:45+0100  
 (function e(t,n){"object"===typeof exports&&"object"===typeof module?module.exports=n():"function"===typeof define&&define.amd?define([],n):"object"===typeof exports?exports["LimelightIngestSDK"]=n():t["LimelightIngestSDK"]=n()})("undefined"!==typeof self?self:this,function(){return function(e){var t={};function n(o){if(t[o])return t[o].exports;var i=t[o]={i:o,l:false,exports:{}};e[o].call(i.exports,i,i.exports,n);i.l=true;return i.exports}n.m=e;n.c=t;n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{configurable:false,enumerable:true,get:o})};n.n=function(e){var t=e&&e.__esModule?function t(){return e["default"]}:function t(){return e};n.d(t,"a",t);return t};n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)};n.p="";return n(n.s=1)}([function(e,t,n){"use strict";var o=Symbol("listeners");var i=function(){function e(){this[o]=new Map}e.prototype.on=function(e,t){var n=this[o].get(e)||[];n.push(t);this[o].set(e,n)};e.prototype.emit=function(e){var t=[];for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];var i=this[o].get(e)||[];for(var a=0,s=i;a<s.length;a++){var r=s[a];r.apply(void 0,t)}};return e}();t["a"]=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:true});t["createIngest"]=r;var o=n(2);var i=n(3);var a="rts.llnwi.net";var s="1.0";function r(e){var t=o["a"](e);return c(t)}function c(e){var t=l(e);var n=document.getElementById(e.videoElementId);return new i["a"](e.account,e.streamName,t,n)}function u(){return null}function l(e){var t=e.overrides||{};var n=t.socketAuthority||e.account+"."+a;var o=d(t.socketSecure);var i=t.socketPath||"play/"+s+"/"+e.account+"/"+e.streamName;return o+"://"+n+"/"+i}function d(e){switch(e){case false:return"ws";default:return"wss"}}},function(e,t,n){"use strict";t["a"]=o;function o(e){return{account:i(e.account,null),streamName:i(e.streamName,null),videoElementId:i(e.videoElementId,"llnw-rts-ingest"),overrides:a(i(e.overrides,{}))}}function i(e,t){return void 0===e||null===e?t:e}function a(e){return{socketAuthority:i(e.socketAuthority,null),socketSecure:i(e.socketSecure,null),socketPath:i(e.socketPath,null)}}},function(e,t,n){"use strict";var o=n(0);var i=n(4);var a=this&&this.__extends||function(){var e=function(t,n){e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return e(t,n)};return function(t,n){e(t,n);function o(){this.constructor=t}t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();var s;(function(e){e[e["Opening"]=1e3]="Opening";e[e["Connected"]=2e3]="Connected";e[e["Authenticated"]=3e3]="Authenticated"})(s||(s={}));var r=function(e){a(t,e);function t(t,n,o,a){var r=e.call(this)||this;r.state=s.Opening;r.localStream=null;r.videoElement=a;r.session=new i["a"](o);r.session.on("connected",function(e){r.state=s.Connected;r.emit("connected",e)});r.session.on("authenticated",function(e){r.state=s.Authenticated;r.emit("authenticated",e)});r.session.on("ingest-active",function(){r.videoElement.srcObject=r.localStream;r.videoElement.play();r.emit("ingest-active",{})});r.session.on("ingest-stopped",function(){r.videoElement.srcObject=null;r.videoElement.currentTime=0;r.emit("ingest-stopped",{})});r.session.on("reset",function(){r.videoElement.srcObject=null;r.videoElement.currentTime=0;r.localStream&&r.localStream.getTracks().forEach(function(e){return e.stop()});r.emit("reset",{})});r.session.on("ingest-audio-stats",function(e){r.emit("ingest-audio-stats",e)});r.session.on("ingest-video-stats",function(e){r.emit("ingest-video-stats",e)});return r}t.prototype.authenticate=function(e,t,n){if(this.state!=s.Connected){console.warn("Attempt to authenticate whilst in invalid state "+this.state);return}this.session.authenticate(e,t,n)};t.prototype.startIngest=function(e,t){if(this.state!=s.Authenticated){console.warn("Attempt to start ingest when not authenticated");return}this.localStream=e;this.session.startIngest(e,t)};t.prototype.stopIngest=function(){if(this.state!=s.Authenticated){console.warn("Attempt to stop ingest when not authenticated");return}this.localStream.getTracks().forEach(function(e){return e.stop()});this.session.stopIngest()};return t}(o["a"]);t["a"]=r},function(e,t,n){"use strict";var o=n(0);var i=this&&this.__extends||function(){var e=function(t,n){e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return e(t,n)};return function(t,n){e(t,n);function o(){this.constructor=t}t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();var a=this&&this.__awaiter||function(e,t,n,o){function i(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||(n=Promise))(function(n,a){function s(e){try{c(o.next(e))}catch(e){a(e)}}function r(e){try{c(o["throw"](e))}catch(e){a(e)}}function c(e){e.done?n(e.value):i(e.value).then(s,r)}c((o=o.apply(e,t||[])).next())})};var s=this&&this.__generator||function(e,t){var n={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},o,i,a,s;return s={next:r(0),throw:r(1),return:r(2)},"function"===typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function r(e){return function(t){return c([e,t])}}function c(s){if(o)throw new TypeError("Generator is already executing.");while(n)try{if(o=1,i&&(a=2&s[0]?i["return"]:s[0]?i["throw"]||((a=i["return"])&&a.call(i),0):i.next)&&!(a=a.call(i,s[1])).done)return a;(i=0,a)&&(s=[2&s[0],a.value]);switch(s[0]){case 0:case 1:a=s;break;case 4:n.label++;return{value:s[1],done:false};case 5:n.label++;i=s[1];s=[0];continue;case 7:s=n.ops.pop();n.trys.pop();continue;default:if(!(a=n.trys,a=a.length>0&&a[a.length-1])&&(6===s[0]||2===s[0])){n=0;continue}if(3===s[0]&&(!a||s[1]>a[0]&&s[1]<a[3])){n.label=s[1];break}if(6===s[0]&&n.label<a[1]){n.label=a[1];a=s;break}if(a&&n.label<a[2]){n.label=a[2];n.ops.push(s);break}a[2]&&n.ops.pop();n.trys.pop();continue}s=t.call(e,n)}catch(e){s=[6,e];i=0}finally{o=a=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:true}}};var r;(function(e){e[e["Opening"]=1e3]="Opening";e[e["AwaitingInitialization"]=2e3]="AwaitingInitialization";e[e["Connected"]=3e3]="Connected";e[e["Authenticated"]=4e3]="Authenticated";e[e["Negotiating"]=5e3]="Negotiating";e[e["Stopping"]=6e3]="Stopping"})(r||(r={}));var c;(function(e){})(c||(c={}));var u=15e3;var l=function(e){i(t,e);function t(t){var n=e.call(this)||this;n.socket=null;n.state=r.Opening;n.serverConfig=null;n.traceId=null;n.peer=null;n.localStream=null;n.requestedBitrate=null;n.serverIngestStopped=false;n.peerConnectionStopped=false;n.socketURL=t;n.createSocket();setInterval(function(){return n.pingSocket()},u);return n}t.prototype.authenticate=function(e,t,n){if(this.state!=r.Connected){console.warn("Attempt to authenticate whilst in invalid state "+this.state);return}this.sendToSocket({type:"authenticate",username:e,password:t,protocol:n})};t.prototype.startIngest=function(e,t){if(this.state!=r.Authenticated){console.warn("Attempt to start ingest when not authenticated");return}this.localStream=e;this.requestedBitrate=t;this.sendToSocket({type:"start-ingest"})};t.prototype.stopIngest=function(){if(this.state!=r.Negotiating){console.warn("Attempt to stop ingest when not negotiating");return}this.sendToSocket({type:"stop-ingest"});this.peer.close();this.state=r.Stopping};t.prototype.createSocket=function(){var e=this;var t=this.socket;this.socket=new WebSocket(this.socketURL);this.socket.onopen=function(n){e.handleSocketOpen(n);if(null!==t){t.onopen=null;t.onclose=null;t.onerror=null;t.onmessage=null;t.close()}};this.socket.onclose=function(t){return e.handleSocketClose(t)};this.socket.onerror=function(t){return e.handleSocketError(t)};this.socket.onmessage=function(t){return e.handleSocketMessage(t)}};t.prototype.beginNegotiation=function(){return a(this,void 0,void 0,function(){var e,t,n,o;var i=this;return s(this,function(a){switch(a.label){case 0:e=this.peer;t=false;e=this.peer=new RTCPeerConnection(this.serverConfig);e.onicecandidate=function(e){return i.handlePeerICECandidate(e)};e.onicegatheringstatechange=function(e){return i.handlePeerICEGatheringStateChange(e)};e.oniceconnectionstatechange=function(e){return i.handlePeerICEConnectionStateChange(e)};e.onconnectionstatechange=function(e){return i.handlePeerConnectionStateChange(e)};e.onsignalingstatechange=function(e){return i.handlePeerSignalingStateChange(e)};e.ontrack=function(e){return i.handlePeerTrack(e)};this.localStream.getTracks().forEach(function(t){console.log("Adding track",t.label);e.addTrack(t)});a.label=1;case 1:a.trys.push([1,4,,5]);return[4,e.createOffer({iceRestart:t,offerToReceiveAudio:false,offerToReceiveVideo:false})];case 2:n=a.sent();n["sdp"]=this.setMediaBitrate(n.sdp,"video",this.requestedBitrate);console.debug("Local description obtained.",n.sdp);this.sendToSocket({type:"sdp.offer",offer:n.sdp});console.debug("Local description sent to server.");return[4,e.setLocalDescription(n)];case 3:a.sent();console.debug("Local description applied.");return[3,5];case 4:o=a.sent();console.error("Something went less than spectacularly whilst configuring the peer.");return[3,5];case 5:return[2]}})})};t.prototype.handleSocketOpen=function(e){console.log("Opened WebSocket to "+this.socketURL+". Waiting for initialization message.");this.state=r.AwaitingInitialization};t.prototype.handleSocketClose=function(e){var t=this;console.warn("The socket closed with code "+e.code+" and reason '"+e.reason+"'");switch(this.state){case r.Opening:break;case r.AwaitingInitialization:break;case r.Connected:break;case r.Authenticated:break;case r.Negotiating:this.serverIngestStopped=true;this.peer.close();this.clearPeerCallbacks();break}this.resetState();this.emit("reset",{});1006==e.code?setTimeout(function(){t.createSocket()},1e3):this.createSocket()};t.prototype.handleSocketError=function(e){console.error("The socket closed due to an error.",e)};t.prototype.handleSocketMessage=function(e){switch(this.state){case r.AwaitingInitialization:this.init_handleSocketMessage(e);break;case r.Connected:this.connected_handleSocketMessage(e);break;case r.Authenticated:this.authenticated_handleSocketMessage(e);break;case r.Negotiating:this.negotiating_handleSocketMessage(e);break;case r.Stopping:this.stopping_handleSocketMessage(e);break}};t.prototype.init_handleSocketMessage=function(e){var t=JSON.parse(e.data);switch(t.type){case"pong":break;case"init":var n={traceId:t.traceId};this.traceId=t.traceId;this.state=r.Connected;console.log("Websocket session connected with identifier "+t.traceId+", moved to state "+r[this.state]);this.emit("connected",n);break;default:this.unexpectedMessage(t)}};t.prototype.connected_handleSocketMessage=function(e){var t=JSON.parse(e.data);switch(t.type){case"pong":break;case"authenticated":var n={};this.state=r.Authenticated;this.serverConfig={iceTransportPolicy:"all",iceServers:t.thisIngest.iceServers,iceCandidatePoolSize:2};console.log("Websocket session authenticated");this.emit("authenticated",n);break;default:this.unexpectedMessage(t)}};t.prototype.authenticated_handleSocketMessage=function(e){var t=JSON.parse(e.data);switch(t.type){case"pong":break;case"ingest-started":console.log("Ingest started, beginning negotiation");this.state=r.Negotiating;this.serverIngestStopped=false;this.peerConnectionStopped=false;this.beginNegotiation();break;default:this.unexpectedMessage(t)}};t.prototype.negotiating_handleSocketMessage=function(e){return a(this,void 0,void 0,function(){var t,n,o;return s(this,function(i){switch(i.label){case 0:t=JSON.parse(e.data);n=t.type;switch(n){case"pong":return[3,1];case"sdp.offer-response":return[3,2];case"ice.candidate":return[3,4];case"dataobject.message":return[3,6];case"dataobject.update-response":return[3,7];case"dataobject.broadcast":return[3,8]}return[3,9];case 1:return[3,10];case 2:o=this.setMediaBitrate(t.response,"video",this.requestedBitrate);console.debug("Remote description obtained.",o);return[4,this.peer.setRemoteDescription({sdp:o,type:"answer"})];case 3:i.sent();console.debug("Remote description applied.");return[3,10];case 4:console.debug("Remote ICE candidate obtained.",t);return[4,this.peer.addIceCandidate(new RTCIceCandidate({sdpMLineIndex:t.index,candidate:t.candidate}))];case 5:i.sent();console.debug("Remote ICE candidate applied.");return[3,10];case 6:console.debug("Received message - from: "+t.sender+", body: "+t.msg);return[3,10];case 7:console.debug("Update response - senderRef: "+t.senderRef+", response: "+t.response);return[3,10];case 8:console.debug("Data Object.",t.object);return[3,10];case 9:this.unexpectedMessage(t);i.label=10;case 10:return[2]}})})};t.prototype.stopping_handleSocketMessage=function(e){var t=JSON.parse(e.data);switch(t.type){case"pong":break;case"ingest-stopped":this.serverIngestStopped=true;this.maybeEmitStopped();break;default:this.unexpectedMessage(t)}};t.prototype.handlePeerICECandidate=function(e){var t=e.candidate;if(null===t){console.log("Local ICE candidate gathering has completed.");this.sendToSocket({type:"ice.done"})}else{console.log("Local ICE candidate received for "+t.sdpMLineIndex+": '"+t.candidate+"'");this.sendToSocket({type:"ice.candidate",candidate:t.candidate,index:t.sdpMLineIndex})}};t.prototype.handlePeerICEGatheringStateChange=function(e){console.debug("ICE Gathering State changed to "+e.target.iceGatheringState)};t.prototype.handlePeerICEConnectionStateChange=function(e){console.debug("ICE Connection State changed to "+e.target.iceConnectionState)};t.prototype.handlePeerConnectionStateChange=function(e){var t=this;console.debug("Connection State changed to "+e.target.connectionState);switch(e.target.connectionState){case"connected":setTimeout(function(){t.reportStats()},1e3);this.emit("ingest-active",{});break;case"failed":this.sendToSocket({type:"stop-ingest"});this.emit("ingest-stopped",{});break}};t.prototype.handlePeerSignalingStateChange=function(e){console.debug("Signaling State changed to "+e.target.signalingState);if("closed"==e.target.signalingState){this.clearPeerCallbacks();this.peer=null;this.peerConnectionStopped=true;this.maybeEmitStopped()}};t.prototype.clearPeerCallbacks=function(){this.peer.onicecandidate=null;this.peer.onicegatheringstatechange=null;this.peer.oniceconnectionstatechange=null;this.peer.onconnectionstatechange=null;this.peer.onsignalingstatechange=null;this.peer.ontrack=null};t.prototype.resetState=function(){this.socket=null;this.state=r.Opening;this.serverConfig=null;this.traceId=null;this.peer=null;this.localStream=null;this.requestedBitrate=null;this.serverIngestStopped=false;this.peerConnectionStopped=false};t.prototype.handlePeerTrack=function(e){console.debug("Got track",e.track)};t.prototype.maybeEmitStopped=function(){if(this.serverIngestStopped&&this.peerConnectionStopped){this.state=r.Authenticated;this.emit("ingest-stopped",{})}};t.prototype.reportStats=function(){var e=this;if(this.state==r.Negotiating){this.peer.getSenders().forEach(function(t){return t.getStats().then(function(n){return e.emit("ingest-"+t.track.kind+"-stats",n)})});setTimeout(function(){e.reportStats()},1e3)}};t.prototype.pingSocket=function(){if(this.state===r.Opening)return;if(this.state===r.AwaitingInitialization)return;this.sendToSocket({type:"ping"})};t.prototype.unexpectedMessage=function(e){console.error("Got unexpected message with type "+e.type+" in state "+this.state+".",e)};t.prototype.sendToSocket=function(e){try{this.socket.send(JSON.stringify(e))}catch(e){switch(e.name){case"InvalidStateError":console.error("Trying to send a message whilst the socket isn't open.");break;case"SyntaxError":console.error("Trying to send a message containing a syntax error.");break;default:console.error("Unexpected error sending a message on the socket.");break}}};t.prototype.setMediaBitrate=function(e,t,n){var o=e.split("\n");var i=-1;for(var a=0;a<o.length;a++)if(0===o[a].indexOf("m="+t)){i=a;break}if(-1===i)return e;i++;while(0===o[i].indexOf("i=")||0===o[i].indexOf("c="))i++;var s;if(0===o[i].indexOf("b")){o[i]="b=AS:"+n;s=o.slice(0,i)}else{s=o.slice(0,i);s.push("b=AS:"+n)}s.push("a=fmtp:102 x-google-start-bitrate="+n+"; x-google-max-bitrate="+Math.trunc(1.1*n)+"; x-google-min-bitrate="+Math.trunc(.75*n));s=s.concat(o.slice(i,o.length));return s.join("\n")};return t}(o["a"]);t["a"]=l}])}); 